<!DOCTYPE html>

<html>

<head>
  <meta charset="utf-8">

  <meta name="color-scheme" content="light dark">
  <link rel="stylesheet" href="css/film.css?v=0.01">
  <script src="/js/jquery.min.js"></script>
  <script src="cordova.js"></script>
  <script>
    var params = new URLSearchParams(document.location.search);
    var FindString = params.get('q')|| '';
    var FindStringE = params.get('qe')|| '';
    document.title = FindString;

  </script>
  <title></title>
</head>

<body>

  <div id="ViewPort">
    <div id='magnet'></div>
    <div id='torrent'></div>
  </div>

  <script>

    FindMagnet(FindString,FindStringE);
    //FindJackett(FindString);


    function checkMagnet(text) {
    // Преобразуем текст к нижнему регистру для универсальной проверки
    text = text.toLowerCase();
    
    // Проверяем, начинается ли текст с "magnet"
    if (text.startsWith("magnet")) {
        return 1;
    } else {
        return 0;
    }
}


    function FindJackett(FindString) {
      var magnet=0;
      var req_out = document.getElementById('torrent');
      var OutMass = [];
      var apiUrl = 'https://allfilmbook.ru/API/Jackett/API/v2.0/indexers/all/results?apikey=gfya9fl9ydhjqxsoax2zwld8fiw7falz&cat=2000&Query=' + FindString;
      $.ajax({
        url: apiUrl,
        timeout: 360000,
        success: function (data) {
          
          var json = JSON.parse(JSON.stringify(data));
          var finds = json.Results.map(function (item) {
            var currentDomain = window.location.origin; // Получить домен
            var Domain = "https://allfilmbook.ru/API/Jackett/";
            
            if (typeof item.Link === 'string') {
              hash = item.Link.replace('http://192.168.0.115:9117/', Domain);
             
            }
            else {
              hash = item.MagnetUri;
             
            }
           
            var name = item.Title;
            var seeders = item.Seeders;
            var leechers = item.Peers;
            var trackersChecked = item.trackersChecked;
            var trackersCheckedFormatted = item.PublishDate;
            var index = trackersCheckedFormatted.indexOf("T");
            trackersCheckedFormatted = trackersCheckedFormatted.substring(0, index);

            var size = item.Size;
            var description = item.Description;
            var sizeGb = (size / (1024 * 1024 * 1024)).toFixed(2);

            var outputData = {
              headData: trackersCheckedFormatted,
              link: hash,
              description: description,
              name: name,
              comments: seeders + "/" + leechers + "/" + sizeGb + "Gb"
            };

            OutMass.push(outputData); // add output data to OutMass array
          });
          OutMass.forEach(function (item, i) {
            link = item.link;
            title = item.name;
            comments = item.comments;
            headData = item.headData;
            magnet=checkMagnet(link);
            if(magnet==0)   finds = finds + ' <tr><td>' + headData + '</td><td><a href="#" onclik="openFileInExternalAppMagnet(\''+link+'\')" >#</a><a href="#" onclick="DownloadSelectFile(\''+link+'\')" title="' + title + '">' + title + '</a></td><td>' + comments + '</td></tr>';
          //  if(magnet==1)   finds = finds + ' <tr><td>' + headData + '</td><td><a href="'+link+'" title="' + title + '" target="_parent" >' + title + '</a></td><td>' + comments + '</td></tr>';
            if(magnet==1)   finds = finds + ' <tr><td>' + headData + '</td><td><a href="#" onclick="openFileInExternalAppMagnet(\''+link+'\')" title="' + title + '">' + title + '</a></td><td>' + comments + '</td></tr>';
           
          })




          if (finds.length < 1) {
            finds = 'Ничего не найдено! Попробуйте без фильтров!';
          } else
            finds = '<table border=1 style="width: 100%;"><tr><td></td><td>Имя</td><td>seeders/leechers/Gb</td></tr>' + finds + '</table>';

          req_out.innerHTML = finds;
          finds = '';


        },
        error: function (error) {
          console.error(error);
        }
      });

    }



    function FindMagnet(FindString,FindStringE) {
      var req_out = document.getElementById('magnet');
  
    var OutMass = [];
    var apiUrl
if (FindString.length>8 )  {
    if (FindStringE.length>8 )  {
        apiUrl = 'https://allfilmbook.ru/API/magnets/search2/'+FindString+'/'+FindStringE;
    } else {
        apiUrl = 'https://allfilmbook.ru/API/magnets/search/'+FindString;
    }

}
else {
    apiUrl = 'https://allfilmbook.ru/API/magnets/search/'+FindStringE;
}



   $.ajax({
      url: apiUrl,
      timeout: 10000,
      success: function(data) {
        var json = JSON.parse(JSON.stringify(data));
        var finds = json.map(function(item) {
          hash = item.MagnetUri;
          var name = item.Title;
          var seeders = item.Seeders;
          var leechers = item.Peers;
          var trackersChecked = item.trackersChecked;
          var trackersCheckedFormatted = item.PublishDate;
          var index = trackersCheckedFormatted.indexOf("T");
          trackersCheckedFormatted = trackersCheckedFormatted.substring(0, index); 
         
          var size = item.Size;
          var description = item.Description;
          var sizeGb = (size / (1024 * 1024 * 1024)).toFixed(2);
  
          var outputData = {
            headData: trackersCheckedFormatted,
            link: hash,
            description: description,
            name: name,
            comments: seeders+'/'+leechers+'/'+sizeGb+'Gb'
          };
          
          OutMass.push(outputData); 
        });
        OutMass.forEach(function (item, i) {
            link=item.link;
            title=item.name;
            comments=item.comments;
            headData=item.headData;
            finds=finds +'<tr><td>'+headData+'</td><td><a href="'+link+'" target="_blank" title="'+title+'">'+title+'</a></td><td>'+comments+'</td></tr>'
        })

        
        

        if (finds.length < 1) {
            finds = 'Ничего не найдено! Попробуйте без фильтров!';
            } else 
            finds = '<table border=1 style="width: 100%;"><tr><td></td><td>Имя</td><td>seeders/leechers/Gb</td></tr>' + finds + '</table>';

            req_out.innerHTML = finds;
        finds = '';
       
      
      },
      error: function(error) {
        console.error(error);
      }
    });
  
  }















function DownloadSelectFile(url) {

  
function simpleHash() {
    var currentDate = new Date();
    fileURL = currentDate.getFullYear()  + (currentDate.getMonth() + 1)  + currentDate.getDate()  + currentDate.getHours()  + currentDate.getMinutes()  + currentDate.getSeconds()  ;

    return fileURL;
}
SelectFileData=simpleHash()+'.torrent';
 

  var fileTransfer = new FileTransfer();
  //var fileURL = cordova.file.externalRootDirectory + SelectFileData; // Путь, по которому будет сохранен файл +'Download/'
  var fileURL = cordova.file.dataDirectory +'files/' + SelectFileData; // Путь, по которому будет сохранен файл +'Download/'
 
  
  var fileURI = encodeURI(url);
  //var fileURI = url;
  

  setTimeout(function() { //fileEntry.toURL()
  fileTransfer.download(
      fileURI,
      fileURL,
      function(entry) {
        openFileInExternalApp(fileURL);
        showNotification('Загрузка '+SelectFileData+' завершена.');

      },
      function(error) {
         let message;

        switch (error.code) {
            case 1:
                message = 'Файл не найден';
                break;
            case 2:
                message = 'Недопустимый URL';
                break;
            case 3:
                message = 'Ошибка подключения';
                break;
            case 4:
                message = 'Отмена операции';
                break;
            case 5:
                message = 'Файл не был изменен';
                break;
            default:
                message = 'Нет соответствия кода ошибки';
        }

        showNotification('Произошла ошибка загрузки: '+fileURL +' ' + message); //error.source
 

      }
  );
}, 200);



/*

$.get(url, {
  type: 'DownloadFile',
  dates: '/'+SelectFileData
}, function(response) {
 
  var fileURL = cordova.file.externalRootDirectory+'Download/' + SelectFileData; // Путь, по которому будет сохранен файл
  saveFile(fileURL, response);
  openFileInExternalApp(fileURL)

}



);
*/



}



function openFileInExternalApp(url) {
  cordova.plugins.fileOpener2.open(
    url,
    'application/x-bittorrent'
);
}
function openFileInExternalAppMagnet(url) {
/*
  cordova.plugins.fileOpener2.open(
    url,
    'text/plain'
);*/
cordova.InAppBrowser.open(url, '_system');

  //navigator.app.loadUrl(url, { openExternal: true });

}










function showNotification(html) {
  var notification = document.createElement('div');
  notification.classList.add('notification');
  notification.innerHTML = html;
  document.body.appendChild(notification);
  setTimeout(() => {
      notification.style.opacity = '0';
      setTimeout(() => {
          document.body.removeChild(notification);
      }, 1000);
  }, 6000);
}



function openExternalURL(url) {
  cordova.plugins.globalization.openURL(url);
}


  </script>

</body>

</html>